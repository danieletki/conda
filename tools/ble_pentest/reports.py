"""Report serialization utilities for BLE pentest runs."""

from __future__ import annotations

import json
from dataclasses import asdict, dataclass, field
from datetime import datetime, timezone
from pathlib import Path
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from typing import Any


def _utc_now() -> datetime:
    return datetime.now(tz=timezone.utc)


@dataclass(frozen=True)
class AttackResult:
    attack: str
    success: bool
    details: dict[str, Any] = field(default_factory=dict)
    started_at: datetime | None = None
    finished_at: datetime | None = None
    error: str | None = None

    @property
    def duration_seconds(self) -> float | None:
        if self.started_at is None or self.finished_at is None:
            return None
        return (self.finished_at - self.started_at).total_seconds()

    def to_dict(self) -> dict[str, Any]:
        payload = asdict(self)
        if self.started_at is not None:
            payload["started_at"] = self.started_at.isoformat()
        if self.finished_at is not None:
            payload["finished_at"] = self.finished_at.isoformat()
        payload["duration_seconds"] = self.duration_seconds
        return payload


@dataclass(frozen=True)
class ReportSummary:
    run_id: str
    created_at: datetime
    results: tuple[AttackResult, ...]

    def to_dict(self) -> dict[str, Any]:
        total = len(self.results)
        passed = sum(1 for r in self.results if r.success)
        failed = total - passed
        return {
            "run_id": self.run_id,
            "created_at": self.created_at.isoformat(),
            "counts": {"total": total, "passed": passed, "failed": failed},
            "results": [r.to_dict() for r in self.results],
        }


class ReportWriter:
    def __init__(self, output_dir: str | Path, *, run_id: str | None = None):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        self.run_id = run_id or _utc_now().strftime("%Y%m%dT%H%M%SZ")

    def build_summary(
        self, results: list[AttackResult] | tuple[AttackResult, ...]
    ) -> ReportSummary:
        return ReportSummary(
            run_id=self.run_id,
            created_at=_utc_now(),
            results=tuple(results),
        )

    def write_summary(
        self, results: list[AttackResult] | tuple[AttackResult, ...]
    ) -> dict[str, Path]:
        summary = self.build_summary(results)
        json_path = self.output_dir / "summary.json"
        md_path = self.output_dir / "summary.md"

        json_path.write_text(self.serialize_json(summary), encoding="utf-8")
        md_path.write_text(self.serialize_markdown(summary), encoding="utf-8")
        return {"json": json_path, "markdown": md_path}

    def serialize_json(self, summary: ReportSummary) -> str:
        return json.dumps(summary.to_dict(), indent=2, sort_keys=True)

    def serialize_markdown(self, summary: ReportSummary) -> str:
        counts = summary.to_dict()["counts"]
        lines: list[str] = []
        lines.append(f"# BLE pentest report ({summary.run_id})")
        lines.append("")
        lines.append(f"Created at: `{summary.created_at.isoformat()}`")
        lines.append("")
        lines.append(
            f"Results: **{counts['passed']} passed**, **{counts['failed']} failed**, **{counts['total']} total**"
        )
        lines.append("")
        lines.append("## Attack results")
        lines.append("")
        lines.append("| Attack | Status | Duration (s) |")
        lines.append("| --- | --- | ---: |")
        for result in summary.results:
            status = "PASS" if result.success else "FAIL"
            duration = result.duration_seconds
            duration_str = f"{duration:.3f}" if duration is not None else ""
            lines.append(f"| `{result.attack}` | {status} | {duration_str} |")

        failures = [r for r in summary.results if not r.success]
        if failures:
            lines.append("")
            lines.append("## Failures")
            lines.append("")
            for result in failures:
                lines.append(f"### `{result.attack}`")
                lines.append("")
                if result.error:
                    lines.append("```")
                    lines.append(result.error.rstrip())
                    lines.append("```")
                else:
                    lines.append("(no error provided)")
                lines.append("")

        return "\n".join(lines) + "\n"
