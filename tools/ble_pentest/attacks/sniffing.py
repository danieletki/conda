"""Passive BLE sniffing helpers.

This module implements a lightweight *advertisement sniffing* test using
``bleak``'s scanning primitives.

Assumptions
-----------
- The host platform provides a working BLE adapter.
- ``bleak`` is installed (these attacks are optional).
- Advertisements are captured via the OS BLE stack, which may not expose every
  link-layer field (this is *not* a substitute for SDR/BTLE sniffers).

Configuration
-------------
The attack reads its configuration from ``config.raw['sniffing']``:

- ``timeout_seconds`` (float, default 5.0): scan duration.
- ``entropy_threshold`` (float, default 4.0): threshold for the cleartext
  heuristic.

The attack returns a details mapping containing:

- ``samples``: serialized advertisement samples.
- ``findings``: human-readable findings suitable for report inclusion.
- ``evidence``: paths to any artifacts written to disk.
"""

from __future__ import annotations

import asyncio
from typing import TYPE_CHECKING

from ..base import BleAttackTest
from .utils import (
    artifact_path,
    bytes_to_hex,
    looks_like_cleartext,
    safe_decode_utf8,
    serialize_datetime,
    utc_now,
    write_jsonl,
)

if TYPE_CHECKING:
    from typing import Any

    from ..base import AttackContext


class SniffingAttack(BleAttackTest):
    """Scan for advertisements and flag likely cleartext payloads."""

    name = "sniffing"
    description = "Captures BLE advertisements and flags likely cleartext payloads"

    async def run(self, ctx: AttackContext) -> dict[str, Any]:
        sniffing_cfg = ctx.config.raw.get("sniffing", {})
        if sniffing_cfg is None:
            sniffing_cfg = {}
        if not isinstance(sniffing_cfg, dict):
            raise TypeError("sniffing config section must be a mapping")

        timeout_seconds = float(sniffing_cfg.get("timeout_seconds", 5.0))
        entropy_threshold = float(sniffing_cfg.get("entropy_threshold", 4.0))

        try:
            from bleak import BleakScanner  # type: ignore[import-not-found]
        except ModuleNotFoundError as exc:  # pragma: no cover
            raise RuntimeError(
                "SniffingAttack requires bleak. Install tools/ble_pentest/requirements-ble.txt"
            ) from exc

        events: list[str] = []
        samples: list[dict[str, Any]] = []

        def detection_callback(device: Any, adv_data: Any) -> None:
            ts = utc_now()
            manufacturer_data = getattr(adv_data, "manufacturer_data", None) or {}
            service_data = getattr(adv_data, "service_data", None) or {}

            sample = {
                "timestamp": serialize_datetime(ts),
                "address": getattr(device, "address", None),
                "name": getattr(device, "name", None)
                or getattr(adv_data, "local_name", None),
                "rssi": getattr(device, "rssi", None)
                or getattr(adv_data, "rssi", None),
                "manufacturer_data": {
                    str(k): bytes_to_hex(v) for k, v in dict(manufacturer_data).items()
                },
                "service_data": {
                    k: bytes_to_hex(v) for k, v in dict(service_data).items()
                },
                "service_uuids": list(getattr(adv_data, "service_uuids", []) or []),
            }

            findings: list[dict[str, Any]] = []
            for key, value in dict(manufacturer_data).items():
                if isinstance(value, (bytes, bytearray)) and looks_like_cleartext(
                    bytes(value), entropy_threshold=entropy_threshold
                ):
                    findings.append(
                        {
                            "type": "cleartext_advertisement_payload",
                            "field": f"manufacturer_data[{key}]",
                            "preview": safe_decode_utf8(bytes(value))
                            or bytes_to_hex(bytes(value)),
                        }
                    )

            for key, value in dict(service_data).items():
                if isinstance(value, (bytes, bytearray)) and looks_like_cleartext(
                    bytes(value), entropy_threshold=entropy_threshold
                ):
                    findings.append(
                        {
                            "type": "cleartext_advertisement_payload",
                            "field": f"service_data[{key}]",
                            "preview": safe_decode_utf8(bytes(value))
                            or bytes_to_hex(bytes(value)),
                        }
                    )

            if findings:
                sample["flags"] = findings

            samples.append(sample)

        scanner = BleakScanner(detection_callback=detection_callback)

        events.append("scanner_start")
        await scanner.start()
        try:
            if timeout_seconds > 0:
                await asyncio.sleep(timeout_seconds)
        finally:
            events.append("scanner_stop")
            await scanner.stop()

        findings: list[dict[str, Any]] = []
        for sample in samples:
            for finding in sample.get("flags", []) or []:
                findings.append({"address": sample.get("address"), **finding})

        evidence_path = artifact_path(
            ctx.report_writer.output_dir,
            run_id=ctx.report_writer.run_id,
            attack=self.name,
            filename="advertisements.jsonl",
        )
        write_jsonl(evidence_path, samples)

        return {
            "events": events,
            "findings": findings,
            "samples": samples,
            "evidence": {"advertisements_jsonl": str(evidence_path)},
        }
