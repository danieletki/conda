// Device Host Exposure (Android)
//
// This script is designed to be injected with Frida into an Android BLE client
// application. It emits a stream of structured events via send().
//
// Notes:
// - Hook coverage is intentionally conservative to avoid destabilising the app.
// - Many applications use higher-level networking stacks (OkHttp, etc.). Extend
//   the hooks below to match the target stack.

'use strict';

function emit(payload) {
  send(payload);
}

emit({ type: 'meta', script: 'device_host_exposure', platform: 'android', ts: Date.now() });

if (!Java.available) {
  emit({ type: 'warning', detail: 'Java runtime not available; is this an Android app process?' });
} else {
  Java.perform(function () {
    var pkgName = null;

    try {
      var ActivityThread = Java.use('android.app.ActivityThread');
      var app = ActivityThread.currentApplication();
      if (app) {
        var ctx = app.getApplicationContext();
        pkgName = ctx.getPackageName();
        emit({ type: 'app.package', package_id: pkgName });

        var pm = ctx.getPackageManager();
        var PackageManager = Java.use('android.content.pm.PackageManager');
        var pkgInfo = pm.getPackageInfo(pkgName, PackageManager.GET_PERMISSIONS.value);
        var perms = pkgInfo.requestedPermissions.value || [];
        var flags = pkgInfo.requestedPermissionsFlags.value || [];

        for (var i = 0; i < perms.length; i++) {
          var granted = false;
          try {
            // REQUESTED_PERMISSION_GRANTED is 0x2
            granted = (flags[i] & 2) !== 0;
          } catch (e) {
            granted = false;
          }
          emit({ type: 'android.permission', name: String(perms[i]), granted: granted });
        }
      } else {
        emit({ type: 'warning', detail: 'Unable to resolve Application context (ActivityThread.currentApplication returned null)' });
      }
    } catch (e) {
      emit({ type: 'error', stage: 'permissions', error: String(e) });
    }

    try {
      var FileInputStream = Java.use('java.io.FileInputStream');
      FileInputStream.$init.overload('java.lang.String').implementation = function (path) {
        emit({ type: 'fs.open', mode: 'read', path: String(path) });
        return this.$init(path);
      };

      var FileOutputStream = Java.use('java.io.FileOutputStream');
      FileOutputStream.$init.overload('java.lang.String').implementation = function (path) {
        emit({ type: 'fs.open', mode: 'write', path: String(path) });
        return this.$init(path);
      };

      emit({ type: 'hooks.installed', category: 'filesystem', ok: true });
    } catch (e) {
      emit({ type: 'error', stage: 'fs_hooks', error: String(e) });
    }

    try {
      var Socket = Java.use('java.net.Socket');
      Socket.connect.overload('java.net.SocketAddress', 'int').implementation = function (endpoint, timeout) {
        emit({ type: 'network.connect', endpoint: String(endpoint), timeout_ms: Number(timeout) });
        return this.connect(endpoint, timeout);
      };

      emit({ type: 'hooks.installed', category: 'network', ok: true });
    } catch (e) {
      emit({ type: 'error', stage: 'network_hooks', error: String(e) });
    }

    try {
      var BluetoothGatt = Java.use('android.bluetooth.BluetoothGatt');
      BluetoothGatt.writeCharacteristic.implementation = function (characteristic) {
        var uuid = null;
        try {
          uuid = characteristic.getUuid().toString();
        } catch (e) {
          uuid = null;
        }
        emit({ type: 'bluetooth.gatt.write', uuid: uuid });
        return this.writeCharacteristic(characteristic);
      };

      emit({ type: 'hooks.installed', category: 'bluetooth', ok: true });
    } catch (e) {
      emit({ type: 'error', stage: 'bluetooth_hooks', error: String(e) });
    }
  });
}
