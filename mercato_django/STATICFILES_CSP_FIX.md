# Static Files and CSP Fix - Docker Deployment

## Problem Summary

This fix addresses two critical issues in the Docker deployment:

### Problem 1: Static Files Not Being Served
- **Symptom**: Django static files returned HTML 404 instead of CSS/JS content
- **Root Cause**: The Django project had no static files in the source directory, so `collectstatic` created an empty or minimal `staticfiles` directory
- **Impact**: Pages appeared unstyled, JavaScript functionality didn't work, and layout was broken

### Problem 2: Content Security Policy (CSP) Too Restrictive
- **Symptom**: External resources (jQuery, Toastr, Google Fonts) were blocked by the browser
- **Root Cause**: Nginx CSP header didn't include the necessary CDN domains
- **Impact**: Interactive features failed, fonts didn't load, and console errors appeared

## Changes Made

### 1. Created Static Files Directory Structure

Created `/static/` directory with the following files:

#### `static/css/style.css`
- Comprehensive stylesheet with:
  - Global styles and CSS variables
  - Navbar, card, button, and form styles
  - Table, badge, and alert styles
  - Footer and dashboard card styles
  - Lottery card specific styles
  - Responsive design breakpoints
  - Animations and utilities

#### `static/js/main.js`
- Main JavaScript file with:
  - Toastr notification initialization
  - AJAX form handling with CSRF token support
  - Form validation and error display
  - Delete confirmation dialogs
  - Card interaction handlers
  - Helper functions (currency/date formatting, debounce)
  - Exported utilities for global use

#### `static/img/lottery-placeholder.svg`
- SVG placeholder image for lotteries without images
- Professional design with MercatoPro branding

### 2. Updated Nginx CSP Header

**File**: `docker/nginx/conf.d/default.conf`

**Before**:
```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net fonts.googleapis.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' fonts.gstatic.com data:; connect-src 'self'; frame-ancestors 'none';" always;
```

**After**:
```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' code.jquery.com cdn.jsdelivr.net cdnjs.cloudflare.com fonts.googleapis.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' fonts.gstatic.com data:; connect-src 'self'; frame-ancestors 'none';" always;
```

**Changes**:
- Added `code.jquery.com` to `script-src` for jQuery
- Added `cdnjs.cloudflare.com` to `script-src` for Toastr JS
- Added `cdnjs.cloudflare.com` to `style-src` for Toastr CSS

### 3. Updated .gitignore

**Changes**:
- Commented out `/static/` exclusion to track source static files
- Commented out `/media/` exclusion to track source media files
- Kept `/staticfiles/` excluded (generated files)

**Rationale**: The source `static/` directory should be tracked in version control, while `staticfiles/` is generated by `collectstatic` at build time.

## How It Works

### Static Files Collection Process

1. **Source Directory**: `/app/static/` (in container) - Contains source static files
2. **Collection**: Docker entrypoint runs `python manage.py collectstatic --noinput`
3. **Destination**: `/app/staticfiles/` (in container) - Contains collected static files
4. **Nginx Mount**: `./staticfiles:/var/www/static:ro` (in docker-compose.yml)
5. **Nginx Alias**: `location /static/ { alias /var/www/static/; }`
6. **Browser Access**: `http://localhost/static/css/style.css`

### Django Settings Configuration

The Django `settings.py` is already correctly configured:

```python
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    BASE_DIR / 'static',  # Source directory
]
STATIC_ROOT = BASE_DIR / 'staticfiles'  # Collection destination
```

## Testing

### Manual Testing Steps

1. **Start Docker Services**:
   ```bash
   docker-compose up -d
   ```

2. **Verify Static Files Were Collected**:
   ```bash
   docker-compose exec web ls -la /app/staticfiles/static/css/
   docker-compose exec web ls -la /app/staticfiles/static/js/
   ```

3. **Test Static File Access**:
   ```bash
   curl -I http://localhost/static/css/style.css
   curl -I http://localhost/static/js/main.js
   ```

   Expected response headers:
   - `Content-Type: text/css` or `application/javascript`
   - `Cache-Control: public, max-age=2592000, immutable`
   - `Status: 200 OK`

4. **Check Browser Console**:
   - Open browser DevTools (F12)
   - Navigate to Console tab
   - Verify no CSP errors
   - Verify jQuery, Toastr, and Google Fonts loaded successfully
   - Verify local `main.js` loaded

5. **Verify Page Styling**:
   - Open http://localhost in browser
   - Check that Bootstrap 5 styles are applied
   - Check that custom styles from `style.css` are applied
   - Verify navigation bar, cards, buttons are styled correctly
   - Check responsive design works on mobile

### Automated Testing

Run the Docker test suite:
```bash
./test_docker.sh
```

Or use make:
```bash
make test-docker
```

Specific tests for static files:
- Test 6: Static files serving
- Test 8: Nginx static files configuration

## Acceptance Criteria

✓ Static files served correctly (CSS, JS)
✓ MIME types correct (text/css, application/javascript)
✓ jQuery loaded from CDN
✓ Toastr loaded from CDN
✓ Google Fonts loaded
✓ main.js loaded
✓ Layout visible on the page
✓ Console errors related to static files resolved

## Additional Notes

### Security Considerations

- **CSP Headers**: The CSP is configured to allow necessary external resources while maintaining security
- **Static File Permissions**: Nginx serves static files as read-only (`:ro` mount)
- **User Isolation**: Docker containers run as non-root user

### Performance Considerations

- **Caching**: Static files are cached for 30 days (CSS/JS) to 365 days (images/fonts)
- **Compression**: Nginx gzip is enabled in main nginx.conf
- **CDN Usage**: External libraries (Bootstrap, jQuery, Toastr) loaded from CDNs

### Development vs Production

- **Development**: Django's `DEBUG=True` mode, collectstatic runs on container start
- **Production**: Consider building static files separately and using a dedicated CDN

### Future Improvements

1. Add Django compressor for CSS/JS minification in production
2. Implement cache-busting with hashed filenames
3. Add source maps for debugging in development
4. Consider using webpack/vite for modern frontend build pipeline
5. Add image optimization for uploaded media files

## Related Files

- `docker/entrypoint.sh` - Runs collectstatic on container startup
- `docker-compose.yml` - Volume mounts for staticfiles
- `docker/nginx/conf.d/default.conf` - Nginx static files serving
- `mercatopro/settings.py` - Django static files configuration
- `.gitignore` - Git ignore patterns (now tracking source static files)
- `templates/base.html` - References static files

## Troubleshooting

### Static Files Still Not Loading

1. Check container logs:
   ```bash
   docker-compose logs web
   docker-compose logs nginx
   ```

2. Verify collectstatic ran:
   ```bash
   docker-compose exec web ls -la /app/staticfiles/
   ```

3. Test Nginx configuration:
   ```bash
   docker-compose exec nginx nginx -t
   docker-compose exec nginx nginx -s reload
   ```

4. Check file permissions:
   ```bash
   docker-compose exec web ls -la /app/staticfiles/static/
   ```

5. Verify volume mounts:
   ```bash
   docker-compose exec nginx ls -la /var/www/static/
   ```

### CSP Errors in Browser Console

1. Check current CSP header:
   ```bash
   curl -I http://localhost/ 2>&1 | grep -i content-security-policy
   ```

2. Verify Nginx configuration was reloaded:
   ```bash
   docker-compose restart nginx
   ```

3. Clear browser cache and reload page

### File Not Found (404) Errors

1. Check if file exists in source directory:
   ```bash
   ls -la static/css/style.css
   ```

2. Rebuild and restart containers:
   ```bash
   docker-compose down
   docker-compose build --no-cache web
   docker-compose up -d
   ```

3. Force collectstatic:
   ```bash
   docker-compose exec web python manage.py collectstatic --noinput --clear
   ```

## Conclusion

This fix resolves both the static files serving issue and the CSP restrictions, ensuring that:
- All static assets (CSS, JS, images) are properly served by Nginx
- External CDN resources (jQuery, Toastr, Google Fonts) are loaded
- The application renders correctly with proper styling and functionality
- Security is maintained through appropriate CSP headers

The solution follows Django and Docker best practices and is production-ready.
