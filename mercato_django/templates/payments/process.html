{% extends 'base.html' %}
{% load static %}

{% block title %}Process Payment - MercatoPro{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fab fa-paypal me-2"></i>
                        Complete Your Payment
                    </h4>
                </div>
                <div class="card-body p-5">
                    <!-- Payment Summary -->
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">Payment Summary</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Lottery:</strong> {{ ticket.lottery.title }}<br>
                                <strong>Ticket Number:</strong> {{ ticket.ticket_number }}<br>
                                <strong>Status:</strong> 
                                <span class="badge bg-warning">Pending Payment</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <h3 class="mb-0 text-primary">
                                    <i class="fas fa-euro-sign me-1"></i>{{ amount }}
                                </h3>
                                <small class="text-muted">Total Amount</small>
                            </div>
                        </div>
                    </div>

                    <!-- Fee Breakdown -->
                    <div class="card border-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-receipt me-2"></i>Fee Breakdown
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Ticket Price:</td>
                                            <td class="text-end">
                                                <strong>
€{{ amount|floatformat:2 }}
                                                </strong>
                                            </td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>Platform Commission (10%):</td>
                                            <td class="text-end">
                                                <strong>-
€{{ commission|floatformat:2 }}
                                                </strong>
                                            </td>
                                        </tr>
                                        <tr class="table-secondary">
                                            <td><strong>Net Amount:</strong></td>
                                            <td class="text-end">
                                                <strong>
€{{ net_amount|floatformat:2 }}
                                                </strong>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Important Notice -->
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Important Notice
                        </h6>
                        <p class="mb-0">
                            A 10% platform commission will be deducted from the ticket price.
                            This covers transaction processing and platform maintenance costs.
                        </p>
                    </div>

                    <!-- PayPal Button Container -->
                    <div id="paypal-button-container" class="text-center mb-4"></div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'mercato_lotteries:detail' ticket.lottery.id %}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Lottery
                        </a>
                        
                        <a href="{% url 'payments:dashboard' %}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>Payment Dashboard
                        </a>
                    </div>

                    <!-- Processing Indicator -->
                    <div id="processing-indicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2">Processing payment...</p>
                    </div>

                    <!-- Payment Result -->
                    <div id="payment-result" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// PayPal Integration Script
document.addEventListener('DOMContentLoaded', function() {
    const ticketId = '{{ ticket.id }}';
    const amount = '{{ amount }}';
    
    // Hide the PayPal button container initially
    const paypalContainer = document.getElementById('paypal-button-container');
    
    // Create a styled PayPal-like button
    const payPalButton = document.createElement('button');
    payPalButton.className = 'btn btn-warning btn-lg px-5 py-3 fw-bold';
    payPalButton.style.cssText = 'background: #ffc107; border-color: #ffc107; color: #000;';
    payPalButton.innerHTML = '<i class="fab fa-paypal me-3 fs-4"></i>Pay with PayPal';
    payPalButton.onclick = function() {
        processPayPalPayment();
    };
    
    paypalContainer.appendChild(payPalButton);
});

function processPayPalPayment() {
    const processingIndicator = document.getElementById('processing-indicator');
    const paymentResult = document.getElementById('payment-result');
    const ticketId = '{{ ticket.id }}';
    
    // Show processing indicator
    processingIndicator.style.display = 'block';
    
    // Step 1: Create PayPal order
    fetch('/payments/paypal/create-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            ticket_id: ticketId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Step 2: Capture the order
            return fetch('/payments/paypal/capture-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    order_id: data.order_id,
                    ticket_id: ticketId
                })
            });
        } else {
            throw new Error(data.error || 'Failed to create PayPal order');
        }
    })
    .then(response => response.json())
    .then(data => {
        processingIndicator.style.display = 'none';
        
        if (data.status === 'success') {
            // Show success message
            paymentResult.innerHTML = `
                <div class="alert alert-success">
                    <h5 class="alert-heading">Payment Successful!</h5>
                    <p>Your payment has been processed successfully. You will be redirected to the transaction details page.</p>
                    <a href="/payments/transaction/${data.transaction_id}/" class="btn btn-success">
                        View Transaction Details
                    </a>
                </div>
            `;
            paymentResult.style.display = 'block';
            
            // Redirect to transaction detail after 3 seconds
            setTimeout(() => {
                window.location.href = `/payments/transaction/${data.transaction_id}/`;
            }, 3000);
        } else {
            throw new Error(data.error || 'Payment capture failed');
        }
    })
    .catch(error => {
        processingIndicator.style.display = 'none';
        paymentResult.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading">Payment Failed</h5>
                <p>${error.message}</p>
                <a href="/payments/process/${ticketId}/" class="btn btn-danger">
                    Try Again
                </a>
            </div>
        `;
        paymentResult.style.display = 'block';
        
        console.error('Payment error:', error);
    });
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}