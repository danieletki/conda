{% extends 'base.html' %}
{% load static %}

{% block title %}Payment History - MercatoPro{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-history me-2"></i>Payment History
                </h1>
                <div>
                    <a href="{% url 'payments:dashboard' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" id="status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Refunded</option>
                                <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
                                <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Date From</label>
                            <input type="date" name="date_from" id="date_from" class="form-control" value="{{ request.GET.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Date To</label>
                            <input type="date" name="date_to" id="date_to" class="form-control" value="{{ request.GET.date_to }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-2"></i>Filter
                            </button>
                            <a href="{% url 'payments:history' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Transaction History ({{ transactions|length }} records)
                    </h6>
                    <div>
                        <button class="btn btn-sm btn-outline-info" onclick="exportToCSV()">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" width="100%" cellspacing="0" id="transactionsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Lottery</th>
                                    <th>Ticket Number</th>
                                    <th>Amount</th>
                                    <th>Commission</th>
                                    <th>Net Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr class="{% if transaction.status == 'completed' %}table-success{% elif transaction.status == 'refunded' %}table-info{% elif transaction.status == 'failed' or transaction.status == 'cancelled' %}table-danger{% endif %}">
                                    <td>
                                        <code>{{ transaction.id|slice:":8" }}</code>
                                        {% if transaction.paypal_order_id %}
                                            <br><small class="text-muted">PP: {{ transaction.paypal_order_id|slice:":8" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ transaction.ticket.lottery.title|truncatechars:25 }}</strong>
                                        <br><small class="text-muted">Value: €{{ transaction.ticket.lottery.item_value }}</small>
                                    </td>
                                    <td>
                                        <code class="text-primary">{{ transaction.ticket.ticket_number }}</code>
                                    </td>
                                    <td class="text-end">
                                        <strong>€{{ transaction.amount|floatformat:2 }}</strong>
                                    </td>
                                    <td class="text-end text-warning">
                                        <strong>-€{{ transaction.commission|floatformat:2 }}</strong>
                                    </td>
                                    <td class="text-end text-success">
                                        <strong>€{{ transaction.net_amount|floatformat:2 }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{% if transaction.status == 'completed' %}success{% elif transaction.status == 'pending' %}warning{% elif transaction.status == 'refunded' %}info{% elif transaction.status == 'failed' %}danger{% else %}secondary{% endif %}">
                                            {{ transaction.get_status_display }}
                                        </span>
                                        {% if transaction.ticket.payment_status == 'completed' %}
                                            <br><small class="text-success">✓ Ticket Paid</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ transaction.created_at|date:"M d, Y" }}</strong>
                                        <br><small class="text-muted">{{ transaction.created_at|time:"H:i:s" }}</small>
                                        {% if transaction.payment_completed_at %}
                                            <br><small class="text-success">Paid: {{ transaction.payment_completed_at|date:"M d" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'payments:payment_detail' transaction.id %}" 
                                               class="btn btn-primary" 
                                               title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'lotteries:detail' transaction.ticket.lottery.id %}" 
                                               class="btn btn-info" 
                                               title="View Lottery">
                                                <i class="fas fa-ticket-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-search fa-3x mb-3"></i>
                                            <h5>No transactions found</h5>
                                            <p>There are no payment transactions matching your criteria.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Help Information -->
            <div class="alert alert-info">
                <h5 class="alert-heading">
                    <i class="fas fa-question-circle me-2"></i>Need Help?
                </h5>
                <p class="mb-0">
                    Track all your payment transactions, commissions, and refunds in one place. 
                    Each transaction includes a 10% platform commission automatically calculated.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Export to CSV functionality
function exportToCSV() {
    const table = document.getElementById('transactionsTable');
    const rows = table.querySelectorAll('tbody tr');
    
    let csv = 'Transaction ID,Ticket Number,Lottery,Amount,Commission,Net Amount,Status,Date\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 1) { // Skip empty rows
            const transactionId = cells[0].textContent.trim();
            const ticketNumber = cells[2].textContent.trim();
            const lottery = cells[1].textContent.trim().replace(/\n/g, ' ');
            const amount = cells[3].textContent.trim().replace('€', '');
            const commission = cells[4].textContent.trim().replace('€', '');
            const net = cells[5].textContent.trim().replace('€', '');
            const status = row.querySelector('.badge') ? row.querySelector('.badge').textContent.trim() : '';
            const date = cells[7].textContent.trim();
            
            csv += `${transactionId},${ticketNumber},"${lottery}",${amount},${commission},${net},${status},"${date}"\n`;
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'payment-history-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}