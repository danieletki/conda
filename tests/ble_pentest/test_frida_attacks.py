from __future__ import annotations

import json
import sys
import types
from pathlib import Path

from tools.ble_pentest.base import AttackContext, run_coroutine_sync
from tools.ble_pentest.config import BlePentestConfig
from tools.ble_pentest.reports import ReportWriter


def _install_fake_frida(*, messages=None):
    if messages is None:
        messages = []

    frida_mod = types.ModuleType("frida")

    class FakeScript:
        def __init__(self, source):
            self.source = source
            self._callbacks = {}
            self.loaded = False
            self.unloaded = False

        def on(self, name, callback):
            self._callbacks[name] = callback

        def load(self):
            self.loaded = True
            cb = self._callbacks.get("message")
            if cb is None:
                return
            for msg in messages:
                cb(msg, None)

        def unload(self):
            self.unloaded = True

    class FakeSession:
        def __init__(self, target):
            self.target = target
            self.scripts = []
            self.detached = False

        def create_script(self, source):
            script = FakeScript(source)
            self.scripts.append(script)
            return script

        def detach(self):
            self.detached = True

    class FakeDevice:
        def __init__(self, endpoint):
            self.endpoint = endpoint
            self.sessions = []

        def attach(self, target):
            session = FakeSession(target)
            self.sessions.append(session)
            return session

    class FakeDeviceManager:
        def __init__(self):
            self.remote_endpoints = []
            self.devices = []

        def add_remote_device(self, endpoint):
            self.remote_endpoints.append(endpoint)
            device = FakeDevice(endpoint)
            self.devices.append(device)
            return device

    manager = FakeDeviceManager()

    def get_device_manager():
        return manager

    def get_usb_device(timeout=0):
        device = FakeDevice(f"usb(timeout={timeout})")
        manager.devices.append(device)
        return device

    def get_local_device():
        device = FakeDevice("local")
        manager.devices.append(device)
        return device

    frida_mod.get_device_manager = get_device_manager
    frida_mod.get_usb_device = get_usb_device
    frida_mod.get_local_device = get_local_device
    frida_mod._manager = manager

    sys.modules["frida"] = frida_mod
    return frida_mod


def test_device_host_exposure_attack_loads_script_and_aggregates_events(tmp_path: Path):
    frida_mod = _install_fake_frida(
        messages=[
            {
                "type": "send",
                "payload": {
                    "type": "android.permission",
                    "name": "android.permission.CAMERA",
                    "granted": True,
                },
            },
            {
                "type": "send",
                "payload": {"type": "fs.open", "mode": "read", "path": "/tmp/a"},
            },
            {
                "type": "send",
                "payload": {
                    "type": "network.connect",
                    "endpoint": "example.com:443",
                    "timeout_ms": 1000,
                },
            },
            {
                "type": "send",
                "payload": {"type": "bluetooth.gatt.write", "uuid": "2a19"},
            },
        ]
    )

    from tools.ble_pentest.attacks.device_host_exposure import DeviceHostExposureAttack

    cfg = BlePentestConfig(
        raw={
            "device_host_exposure": {
                "platform": "android",
                "package_id": "com.example.app",
                "endpoint": "127.0.0.1:27042",
                "duration_seconds": 0.0,
            }
        }
    )
    writer = ReportWriter(tmp_path, run_id="testrun")
    ctx = AttackContext(config=cfg, report_writer=writer)

    result = run_coroutine_sync(DeviceHostExposureAttack().execute(ctx))
    assert result.success is True

    assert frida_mod._manager.remote_endpoints == ["127.0.0.1:27042"]

    summary = result.details["summary"]
    assert [p["name"] for p in summary["permissions"]] == ["android.permission.CAMERA"]
    assert summary["filesystem"]
    assert summary["network"]
    assert summary["bluetooth"]

    finding_types = {f["type"] for f in result.details["findings"]}
    assert "dangerous_permission_granted" in finding_types
    assert "filesystem_access_observed" in finding_types
    assert "network_access_observed" in finding_types
    assert "bluetooth_api_usage_observed" in finding_types

    evidence = Path(result.details["evidence"]["frida_events_json"])
    assert evidence.exists()
    payload = json.loads(evidence.read_text(encoding="utf-8"))
    assert payload["package_id"] == "com.example.app"

    device = frida_mod._manager.devices[0]
    session = device.sessions[0]
    assert session.target == "com.example.app"
    assert session.scripts
    assert "Device Host Exposure (Android)" in session.scripts[0].source
