from __future__ import annotations

import json
from datetime import datetime, timezone
from typing import TYPE_CHECKING

from tools.ble_pentest.reports import AttackResult, ReportWriter

if TYPE_CHECKING:
    from pathlib import Path


def test_report_writer_emits_json_and_markdown(tmp_path: Path):
    started = datetime(2020, 1, 1, tzinfo=timezone.utc)
    finished = datetime(2020, 1, 1, 0, 0, 1, tzinfo=timezone.utc)
    results = [
        AttackResult(
            attack="noop",
            success=True,
            details={"k": "v"},
            started_at=started,
            finished_at=finished,
        ),
        AttackResult(
            attack="echo_targets",
            success=False,
            details={},
            error="boom",
        ),
    ]

    writer = ReportWriter(tmp_path, run_id="testrun")
    paths = writer.write_summary(results)

    assert paths["json"].exists()
    assert paths["markdown"].exists()

    payload = json.loads(paths["json"].read_text(encoding="utf-8"))
    assert payload["run_id"] == "testrun"
    assert payload["counts"] == {"failed": 1, "passed": 1, "total": 2}
    assert [r["attack"] for r in payload["results"]] == ["noop", "echo_targets"]

    md = paths["markdown"].read_text(encoding="utf-8")
    assert "# BLE pentest report (testrun)" in md
    assert "`noop`" in md
    assert "FAIL" in md
