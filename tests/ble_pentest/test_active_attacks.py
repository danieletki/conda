"""Unit tests for active BLE attacks (MITM, Jamming, Pairing Bypass)."""

from __future__ import annotations

import json
import sys
import types
from pathlib import Path
from unittest import mock

from tools.ble_pentest.base import AttackContext, run_coroutine_sync
from tools.ble_pentest.config import BlePentestConfig, BleTarget
from tools.ble_pentest.reports import ReportWriter


def _install_fake_bleak_with_services():
    """Install a minimal fake bleak module with service enumeration."""

    bleak_mod = types.ModuleType("bleak")

    class FakeService:
        def __init__(self, uuid):
            self.uuid = uuid

    class FakeClient:
        instances = []

        def __init__(self, address, **kwargs):
            self.address = address
            self.kwargs = kwargs
            self.connected = False
            self.disconnected = False
            self._services = [
                FakeService("0000180a-0000-1000-8000-00805f9b34fb"),
                FakeService("0000180f-0000-1000-8000-00805f9b34fb"),
            ]
            FakeClient.instances.append(self)

        @property
        def services(self):
            return self._services

        async def connect(self):
            self.connected = True

        async def disconnect(self):
            self.disconnected = True

        async def pair(self, protection_level=2):
            pass

    bleak_mod.BleakClient = FakeClient
    sys.modules["bleak"] = bleak_mod

    return FakeClient


class TestMitmAttack:
    """Tests for MitmAttack."""

    def test_mitm_attack_executes_without_error(self, tmp_path):
        """Test that MITM attack can execute successfully."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.mitm import MitmAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "mitm": {
                    "app_address": "AA:BB:CC:DD:EE:FF",
                    "proxy_timeout_seconds": 5.0,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(MitmAttack().execute(ctx))
        assert result.success is True
        assert result.details["target"] == "11:22:33:44:55:66"
        assert result.details["app_address"] == "AA:BB:CC:DD:EE:FF"
        assert "proxy_start" in result.details["events"]
        assert "proxy_stop" in result.details["events"]

    def test_mitm_attack_tracks_telemetry(self, tmp_path):
        """Test that MITM attack collects telemetry metrics."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.mitm import MitmAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "mitm": {
                    "app_address": "AA:BB:CC:DD:EE:FF",
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(MitmAttack().execute(ctx))
        assert result.success is True

        telemetry = result.details["telemetry"]
        assert "throughput_bytes" in telemetry
        assert "disconnect_count" in telemetry
        assert "connection_count" in telemetry
        assert "forwarded_reads" in telemetry
        assert "forwarded_writes" in telemetry
        assert "mutations_count" in telemetry

    def test_mitm_attack_supports_payload_mutations(self, tmp_path):
        """Test that MITM attack applies payload mutations."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.mitm import MitmAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "mitm": {
                    "app_address": "AA:BB:CC:DD:EE:FF",
                    "mutation_hooks": [
                        {
                            "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
                            "direction": "response",
                            "mutation_type": "xor_byte",
                            "mutation_param": 0xFF,
                        },
                        {
                            "characteristic_uuid": "00002a1c-0000-1000-8000-00805f9b34fb",
                            "direction": "request",
                            "mutation_type": "truncate",
                            "mutation_param": 2,
                        },
                    ],
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(MitmAttack().execute(ctx))
        assert result.success is True

        mutations = result.details["mutations"]
        assert len(mutations) == 2
        assert mutations[0]["mutation_type"] == "xor_byte"
        assert mutations[1]["mutation_type"] == "truncate"
        assert "original_payload_hex" in mutations[0]
        assert "mutated_payload_hex" in mutations[0]

    def test_mitm_attack_dry_run_mode(self, tmp_path):
        """Test that MITM attack respects dry_run flag."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.mitm import MitmAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "mitm": {
                    "app_address": "AA:BB:CC:DD:EE:FF",
                    "dry_run": True,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(MitmAttack().execute(ctx))
        assert result.success is True
        assert result.details["dry_run"] is True
        assert "dry_run_mode" in result.details["events"]

    def test_mitm_attack_writes_evidence_artifact(self, tmp_path):
        """Test that MITM attack writes evidence to disk."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.mitm import MitmAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "mitm": {
                    "app_address": "AA:BB:CC:DD:EE:FF",
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(MitmAttack().execute(ctx))
        assert result.success is True

        evidence_path = Path(result.details["evidence"]["trace_json"])
        assert evidence_path.exists()

        evidence_data = json.loads(evidence_path.read_text(encoding="utf-8"))
        assert evidence_data["target"] == "11:22:33:44:55:66"
        assert evidence_data["app_address"] == "AA:BB:CC:DD:EE:FF"
        assert "transactions" in evidence_data
        assert "events" in evidence_data


class TestJammingAttack:
    """Tests for JammingAttack."""

    def test_jamming_attack_executes_without_error(self, tmp_path):
        """Test that jamming attack can execute successfully."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "duration_seconds": 5.0,
                    "connection_attempt_rate": 2,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True
        assert result.details["target"] == "11:22:33:44:55:66"
        assert "jamming_start" in result.details["events"]
        assert "jamming_stop" in result.details["events"]

    def test_jamming_attack_collects_connection_metrics(self, tmp_path):
        """Test that jamming attack tracks connection attempts."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "duration_seconds": 3.0,
                    "connection_attempt_rate": 1,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True

        telemetry = result.details["telemetry"]
        assert "total_attempts" in telemetry
        assert "successful_connections" in telemetry
        assert "failed_connections" in telemetry
        assert "disconnect_count" in telemetry
        assert "advertisement_floods" in telemetry
        assert "success_rate_percent" in telemetry

    def test_jamming_attack_respects_duty_cycle(self, tmp_path):
        """Test that jamming attack respects duty cycle configuration."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "duration_seconds": 5.0,
                    "duty_cycle_percent": 50,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True

        telemetry = result.details["telemetry"]
        assert telemetry["active_time_seconds"] > 0
        assert telemetry["inactive_time_seconds"] > 0

    def test_jamming_attack_enforces_rate_limit(self, tmp_path):
        """Test that jamming attack enforces safety rate limits."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "duration_seconds": 2.0,
                    "connection_attempt_rate": 100,
                    "rate_limit_attempts_per_second": 5,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True

        telemetry = result.details["telemetry"]
        attempt_rate = telemetry["total_attempts"] / 2.0
        assert attempt_rate <= 5.5

    def test_jamming_attack_dry_run_mode(self, tmp_path):
        """Test that jamming attack respects dry_run flag."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "dry_run": True,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True
        assert result.details["dry_run"] is True
        assert "dry_run_mode" in result.details["events"]

    def test_jamming_attack_writes_evidence_artifact(self, tmp_path):
        """Test that jamming attack writes evidence to disk."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.jamming import JammingAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "jamming": {
                    "duration_seconds": 2.0,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(JammingAttack().execute(ctx))
        assert result.success is True

        evidence_path = Path(result.details["evidence"]["trace_json"])
        assert evidence_path.exists()

        evidence_data = json.loads(evidence_path.read_text(encoding="utf-8"))
        assert evidence_data["target"] == "11:22:33:44:55:66"
        assert "attempts" in evidence_data
        assert "events" in evidence_data


class TestPairingBypassAttack:
    """Tests for PairingBypassAttack."""

    def test_pairing_bypass_attack_executes_without_error(self, tmp_path):
        """Test that pairing bypass attack can execute successfully."""
        FakeClient = _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "max_attempts": 2,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True
        assert result.details["target"] == "11:22:33:44:55:66"
        assert "pairing_bypass_start" in result.details["events"]
        assert "pairing_bypass_stop" in result.details["events"]

    def test_pairing_bypass_attack_tracks_pairing_outcomes(self, tmp_path):
        """Test that pairing bypass attack tracks pairing success/failure."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "max_attempts": 3,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True

        telemetry = result.details["telemetry"]
        assert "total_attempts" in telemetry
        assert "successful_pairings" in telemetry
        assert "rejected_pairings" in telemetry
        assert "timeout_count" in telemetry
        assert "rejection_rate_percent" in telemetry

    def test_pairing_bypass_attack_varies_io_capability(self, tmp_path):
        """Test that pairing bypass attack varies IO capability parameters."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "max_attempts": 3,
                    "io_capability_tamper": "display_only",
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True

        attempts = result.details["attempts"]
        assert len(attempts) == 3

        io_capabilities = [a["io_capability"] for a in attempts]
        assert len(set(io_capabilities)) > 1, "Should vary IO capabilities"

    def test_pairing_bypass_attack_tracks_rejections(self, tmp_path):
        """Test that pairing bypass attack tracks rejection details."""
        FakeClient = _install_fake_bleak_with_services()

        class FailingFakeClient:
            instances = []

            def __init__(self, address, **kwargs):
                self.address = address
                self.kwargs = kwargs
                self.connected = False
                self.disconnected = False
                FailingFakeClient.instances.append(self)

            async def connect(self):
                self.connected = True

            async def disconnect(self):
                self.disconnected = True

            async def pair(self, protection_level=2):
                raise Exception("Pairing rejected by device")

        sys.modules["bleak"].BleakClient = FailingFakeClient

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "max_attempts": 2,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True

        rejections = result.details["rejections"]
        assert len(rejections) > 0
        assert all("reason" in r for r in rejections)

    def test_pairing_bypass_attack_dry_run_mode(self, tmp_path):
        """Test that pairing bypass attack respects dry_run flag."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "dry_run": True,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True
        assert result.details["dry_run"] is True
        assert "dry_run_mode" in result.details["events"]

    def test_pairing_bypass_attack_writes_evidence_artifact(self, tmp_path):
        """Test that pairing bypass attack writes evidence to disk."""
        _install_fake_bleak_with_services()

        from tools.ble_pentest.attacks.pairing_bypass import PairingBypassAttack

        cfg = BlePentestConfig(
            targets=(BleTarget(address="11:22:33:44:55:66"),),
            raw={
                "pairing_bypass": {
                    "max_attempts": 2,
                }
            },
        )
        writer = ReportWriter(tmp_path, run_id="testrun")
        ctx = AttackContext(config=cfg, report_writer=writer)

        result = run_coroutine_sync(PairingBypassAttack().execute(ctx))
        assert result.success is True

        evidence_path = Path(result.details["evidence"]["trace_json"])
        assert evidence_path.exists()

        evidence_data = json.loads(evidence_path.read_text(encoding="utf-8"))
        assert evidence_data["target"] == "11:22:33:44:55:66"
        assert "attempts" in evidence_data
        assert "events" in evidence_data


class TestPayloadMutations:
    """Tests for payload mutation helpers."""

    def test_xor_mutation_type(self):
        """Test XOR byte mutation."""
        from tools.ble_pentest.attacks.mitm import _apply_mutation

        payload = bytes([0xAA, 0xBB, 0xCC])
        mutation = {"mutation_type": "xor_byte", "mutation_param": 0xFF}
        result = _apply_mutation(payload, mutation)

        assert result == bytes([0x55, 0x44, 0x33])

    def test_flip_bits_mutation_type(self):
        """Test flip bits mutation."""
        from tools.ble_pentest.attacks.mitm import _apply_mutation

        payload = bytes([0b10000000])
        mutation = {"mutation_type": "flip_bits", "mutation_param": 0}
        result = _apply_mutation(payload, mutation)

        assert result == bytes([0b10000001])

    def test_truncate_mutation_type(self):
        """Test truncate mutation."""
        from tools.ble_pentest.attacks.mitm import _apply_mutation

        payload = bytes([0xAA, 0xBB, 0xCC, 0xDD])
        mutation = {"mutation_type": "truncate", "mutation_param": 2}
        result = _apply_mutation(payload, mutation)

        assert result == bytes([0xAA, 0xBB])

    def test_inject_pattern_mutation_type(self):
        """Test inject pattern mutation."""
        from tools.ble_pentest.attacks.mitm import _apply_mutation

        payload = bytes([0xAA, 0xBB])
        mutation = {"mutation_type": "inject_pattern", "mutation_param": "XX"}
        result = _apply_mutation(payload, mutation)

        assert result == bytes([0xAA, 0xBB]) + b"XX"

    def test_unknown_mutation_type_returns_unchanged(self):
        """Test that unknown mutation type returns payload unchanged."""
        from tools.ble_pentest.attacks.mitm import _apply_mutation

        payload = bytes([0xAA, 0xBB, 0xCC])
        mutation = {"mutation_type": "unknown_mutation"}
        result = _apply_mutation(payload, mutation)

        assert result == payload
