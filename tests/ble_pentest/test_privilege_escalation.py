from __future__ import annotations

import sys
import types
from pathlib import Path

from tools.ble_pentest.base import AttackContext, run_coroutine_sync
from tools.ble_pentest.config import BlePentestConfig, BleTarget
from tools.ble_pentest.reports import ReportWriter


def _install_fake_bleak(*, reads=None):
    if reads is None:
        reads = [b""]

    bleak_mod = types.ModuleType("bleak")

    class FakeClient:
        instances = []

        def __init__(self, address, **kwargs):
            self.address = address
            self.kwargs = kwargs
            self.connected = False
            self.disconnected = False
            self.writes = []
            self._read_index = 0
            FakeClient.instances.append(self)

        async def connect(self):
            self.connected = True

        async def disconnect(self):
            self.disconnected = True

        async def write_gatt_char(self, uuid, data, response=False):
            self.writes.append(
                {"uuid": uuid, "data": bytes(data), "response": bool(response)}
            )

        async def read_gatt_char(self, uuid):
            if self._read_index < len(reads):
                value = reads[self._read_index]
            else:
                value = reads[-1]
            self._read_index += 1
            return value

    bleak_mod.BleakClient = FakeClient
    sys.modules["bleak"] = bleak_mod

    return FakeClient


def test_privilege_escalation_attack_fuzzes_bounds_and_flags_privileged_acceptance(
    tmp_path: Path,
):
    _install_fake_bleak(reads=[b"ok", b"ok"])

    from tools.ble_pentest.attacks.privilege_escalation import PrivilegeEscalationAttack

    cfg = BlePentestConfig(
        targets=(BleTarget(address="11:22:33:44:55:66"),),
        raw={
            "privilege_escalation": {
                "characteristic_uuid": "00002a19-0000-1000-8000-00805f9b34fb",
                "opcodes": [1],
                "privileged_opcodes": [1],
                "min_value": 0,
                "max_value": 1,
                "value_size": 1,
                "max_cases": 10,
            }
        },
    )
    writer = ReportWriter(tmp_path, run_id="testrun")
    ctx = AttackContext(config=cfg, report_writer=writer)

    result = run_coroutine_sync(PrivilegeEscalationAttack().execute(ctx))
    assert result.success is True

    assert len(result.details["cases"]) == 2

    finding_types = {f["type"] for f in result.details["findings"]}
    assert "privileged_opcode_accepted" in finding_types
    assert "control_command_response_observed" in finding_types

    evidence = Path(result.details["evidence"]["fuzz_cases_json"])
    assert evidence.exists()
